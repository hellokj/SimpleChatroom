
<h1>SimpleChatRoom</h1>

<input type="text" id="nameBox" placeholder="Type your name here" style="display: block; margin-bottom: 10px; padding: 10px;" />
<input type="text" id="roomBox" placeholder="Type room here" style="display: block; margin-bottom: 10px; padding: 10px;" />
<button id="connect" title="Connect" style="height: 30px;">Connect</button>
<button id="disconnect" title="Disconnect" style="height: 30px;">Disconnect</button>
<pre id="messages" style="height: 400px; overflow: scroll"></pre>
<input type="text" id="messageBox" placeholder="Type your message here" style="display: block; width: 100%; margin-bottom: 10px; padding: 10px;" />
<button id="send" title="Send Message!" style="width: 100%; height: 30px;">Send Message</button>

<script>
  (function() {
    const roomBox = document.querySelector('#roomBox')
    const nameBox = document.querySelector('#nameBox')
    const disconnectBtn = document.querySelector('#disconnect')
    const connectBtn = document.querySelector('#connect')
    const sendBtn = document.querySelector('#send');
    const messages = document.querySelector('#messages');
    const messageBox = document.querySelector('#messageBox');

    let ws;
    let clientId;
    let roomId;

    function showMessage(rawData) {
      var reply = JSON.parse(rawData)
      
      messages.textContent += `\n\n${reply.Content}`;
      messages.scrollTop = messages.scrollHeight;
      messageBox.value = '';
    }

    disconnectBtn.onclick = function(){
        if (ws) {
            var message = {
                "ClientId": clientId,
                "RoomId": roomBox.value,
                "Action": "Leave",
                "NickName": nameBox.value,
                "Content": ""
            }
            ws.send(JSON.stringify(message))
            messages.textContent += `\n\nDisconnected`;
            messages.scrollTop = messages.scrollHeight;
            messageBox.value = '';
            
            roomBox.readOnly = false
        }
    }

    connectBtn.onclick = function() {
      if (ws) {
        ws.onerror = ws.onopen = ws.onclose = null;
        ws.close();
      }

      ws = new WebSocket('ws://localhost:8080/websocket');
      ws.onopen = () => {
        console.log('Connection opened!');
        if (!clientId){
            clientId = _uuid()
        }
        var message = {
          "ClientId": clientId,
          "RoomId": roomBox.value,
          "Action": "Join",
          "NickName": nameBox.value,
          "Content": ""
        }
        ws.send(JSON.stringify(message))
      }
        ws.onmessage = ({data}) => { showMessage(data) };
        ws.onclose = function() {
          ws = null;
        }
        roomBox.readOnly = true
    }

    function _uuid() {
        var d = Date.now();
        if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
            d += performance.now(); //use high-precision timer if available
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }

    function showErrorMessage(message){
      messages.textContent += `\n\n${message}`;
      messages.scrollTop = messages.scrollHeight;
      messageBox.value = '';
    }

    sendBtn.onclick = function() {
      if (!ws) {
        showErrorMessage("No WebSocket connection :(")
        return ;
      } else {
        if (!roomBox.value) {
          alert("Should not send empty string.");
      }
        var message = {
            "ClientId": clientId,
            "RoomId": roomBox.value,
            "Action": "Broadcast",
            "NickName": nameBox.value,
            "Content": messageBox.value
        }
        
        ws.send(JSON.stringify(message));
      }

    }

    window.onbeforeunload = function() {
        var message = {
                "ClientId": clientId,
                "RoomId": roomBox.value,
                "Action": "Leave",
                "NickName": nameBox.value,
                "Content": ""
            }
        ws.send(JSON.stringify(message))
    }

    window.addEventListener("beforeunload", function(_){
        var message = {
                "ClientId": clientId,
                "RoomId": roomBox.value,
                "Action": "Leave",
                "NickName": nameBox.value,
                "Content": ""
            }
        ws.send(JSON.stringify(message))
    }, false)

  })();
</script>
